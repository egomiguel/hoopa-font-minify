"use strict";angular.module("myApp.Projects",["ngRoute"]).config(["$routeProvider",function(e){e.when("/projects",{templateUrl:"views/projects/projects.html",controller:"ProjectsCtrl"})}]).controller("ProjectsCtrl",["$rootScope","$scope","$routeParams","$window","$translate",function(e,r,t,n,a){e.showBanner=!1,r.products=[],r.currentPage=1,r.pageSize=8,r.productsCount=0,r.phoneNumber="",r.smsCode="",r.provinces=["区域无限制","安徽省","北京市","重庆市","福建省","广东省","甘肃省","广西壮族自治区","贵州省","河南省","湖北省","河北省","海南省","香港特别行政区","黑龙江省","湖南省","吉林省","江苏省","江西省","辽宁省","澳门特别行政区","內蒙古自治区","宁夏回族自治区","青海省","四川省","山东省","上海市","陕西省","山西省","天津市","台湾省","新疆维吾尔自治区","西藏自治区","云南省","浙江省"],r.typeArrivalArray=["抵押物类型","住宅","商铺","写字楼","厂房","在建工程","机械设备，存货，原材料","土地（无厂房","林权","海城使用权","商住","无抵押","其他"],r.amountArray=["本金无限制","500万","500-1000万","1000-1500万","1500-2000万","2000-2500万","2500-3000万","3000-3500万","3500-4000万","4000-4500万","4500-5000万","5000-5500万","5500-6000万","6000万"],r.filters={province:"区域无限制",type:"抵押物类型",amount:"本金无限制",text:""},r.resetFilters=function(){e.searchFilterText="",r.filters={province:"区域无限制",type:"抵押物类型",amount:"本金无限制",text:""}},r.$on("searchTextUpdated",function(t,n){r.filters.text=e.searchFilterText,r.applyFilters()}),r.applyFilters=function(){r.products=[];var e=AV.User.current(),t=new AV.Query("Project");"抵押物类型"!=r.filters.type&&t.contains("typeArrivalString",r.filters.type);var n=new AV.Query("Project");"区域无限制"!=r.filters.province&&n.contains("provinceString",r.filters.province);var a="";switch(r.filters.amount){case"本金无限制":a=new AV.Query("Project");break;case"500万":(a=new AV.Query("Project")).lessThanOrEqualTo("debitAmount",500);break;case"500-1000万":(o=new AV.Query("Project")).greaterThan("debitAmount",500),(u=new AV.Query("Project")).lessThanOrEqualTo("debitAmount",1e3);a=AV.Query.and(o,u);break;case"1000-1500万":(o=new AV.Query("Project")).greaterThan("debitAmount",1e3),(u=new AV.Query("Project")).lessThanOrEqualTo("debitAmount",1500);a=AV.Query.and(o,u);break;case"1500-2000万":(o=new AV.Query("Project")).greaterThan("debitAmount",1500),(u=new AV.Query("Project")).lessThanOrEqualTo("debitAmount",2e3);a=AV.Query.and(o,u);break;case"2000-2500万":(o=new AV.Query("Project")).greaterThan("debitAmount",2e3),(u=new AV.Query("Project")).lessThanOrEqualTo("debitAmount",2500);a=AV.Query.and(o,u);break;case"2500-3000万":(o=new AV.Query("Project")).greaterThan("debitAmount",2500),(u=new AV.Query("Project")).lessThanOrEqualTo("debitAmount",3e3);a=AV.Query.and(o,u);break;case"3000-3500万":(o=new AV.Query("Project")).greaterThan("debitAmount",3e3),(u=new AV.Query("Project")).lessThanOrEqualTo("debitAmount",3500);a=AV.Query.and(o,u);break;case"3500-4000万":(o=new AV.Query("Project")).greaterThan("debitAmount",3500),(u=new AV.Query("Project")).lessThanOrEqualTo("debitAmount",4e3);a=AV.Query.and(o,u);break;case"4000-4500万":(o=new AV.Query("Project")).greaterThan("debitAmount",4e3),(u=new AV.Query("Project")).lessThanOrEqualTo("debitAmount",4500);a=AV.Query.and(o,u);break;case"4500-5000万":(o=new AV.Query("Project")).greaterThan("debitAmount",4500),(u=new AV.Query("Project")).lessThanOrEqualTo("debitAmount",5e3);a=AV.Query.and(o,u);break;case"5000-5500万":(o=new AV.Query("Project")).greaterThan("debitAmount",5e3),(u=new AV.Query("Project")).lessThanOrEqualTo("debitAmount",5500);a=AV.Query.and(o,u);break;case"5500-6000万":var o,u;(o=new AV.Query("Project")).greaterThan("debitAmount",5500),(u=new AV.Query("Project")).lessThanOrEqualTo("debitAmount",6e3);a=AV.Query.and(o,u);break;case"6000万":(a=new AV.Query("Project")).greaterThan("debitAmount",6e3);break;default:a=new AV.Query("Project")}var c=AV.Query.and(n,a,t),s=new AV.Query("Project");s.contains("title",r.filters.text);var i=new AV.Query("Project");i.contains("description",r.filters.text);var l=AV.Query.or(i,s),p=AV.Query.and(c,l);p.count().then(function(e){r.productsCount=e}),p.limit(r.pageSize),p.skip((r.currentPage-1)*r.pageSize),p.descending("createdAt"),p.find().then(function(t){t.forEach(function(t,n){var a=t.id,o=t.get("title"),u=o;if(o.length>25){u="";for(var c=0;c<25;c++)u+=o[c];u+="..."}o=u;var s=t.get("description"),i=s;if(s.length>50){i="";for(c=0;c<50;c++)i+=s[c];i+="..."}s=i;var l,p=t.createdAt.getMonth()+1+"/"+t.createdAt.getDate()+"/"+t.createdAt.getFullYear(),A=t.get("creator").get("username"),d=t.get("image"),y=t.get("debitAmount"),h=t.get("plainAddress");l=d?d.thumbnailURL(320,200):"img/LogoHoopa.png",r.products.push({id:a,imageUrl:l,title:o,description:s,debitAmount:y,plainAddress:h,ownerUsername:A,releaseTime:p,wished:!1}),e&&r.setWish(r.products,n,t,e),r.$apply()}),r.loading=!1,r.$apply()}).catch(function(e){r.loading=!1,r.$apply(),console.log(e)})},r.applyFiltersClick=function(){r.currentPage=1,r.applyFilters()},r.setWish=function(e,t,n,a){var o=new AV.Query("ShopCar");o.equalTo("project",n),o.equalTo("user",a),o.count().then(n=>{n>0&&(e[t].wished=!0),r.$apply()})},r.applyFilters(),r.begin=function(){r.currentPage=1,r.applyFilters(),$("html,body").scrollTop(0)},r.end=function(){var e=Math.floor(r.productsCount/r.pageSize),t=r.productsCount%r.pageSize;r.currentPage=e,t>0&&(r.currentPage=e+1),r.applyFilters(),$("html,body").scrollTop(0)},r.nextPage=function(){var e=Math.floor(r.productsCount/r.pageSize),t=r.productsCount%r.pageSize;r.currentPage==e&&t>0&&(r.currentPage=e+1),r.currentPage<e&&(r.currentPage=r.currentPage+1),r.applyFilters(),$("html,body").scrollTop(0)},r.previousPage=function(){r.currentPage>1&&(r.currentPage=r.currentPage-1,r.applyFilters()),$("html,body").scrollTop(0)},r.goToProject=function(r){e.customGoTo("project-details/"+r)},r.addToWhishList=function(t){var n=AV.User.current();if(n){var o=AV.Object.createWithoutData("Project",t),u=new AV.Query("ShopCar");u.equalTo("project",o),u.equalTo("user",n),u.count().then(t=>{if(t>0){var u=a.instant("ALREADYINWISHLIST");e.displayAlert("warning",u)}else{var c=new AV.Object("ShopCar");c.set("user",n),c.set("checked",!1),c.set("project",o),c.save().then(t=>{var n=a.instant("ADDEDWISHLIST");e.displayAlert("success",n),r.applyFilters()})}})}else e.customGoTo("login/projects")},r.removeToWhishList=function(t){var n=AV.User.current();if(n){var o=AV.Object.createWithoutData("Project",t),u=new AV.Query("ShopCar");u.equalTo("project",o),u.equalTo("user",n),u.find().then(t=>{t.forEach(function(r){r.destroy();var t=a.instant("REMOVEDWISHLIST");e.displayAlert("success",t)}),r.applyFilters()})}}}]);