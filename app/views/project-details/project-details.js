"use strict";angular.module("myApp.ProjectDetails",["ngRoute"]).config(["$routeProvider",function(e){e.when("/project-details/:id",{templateUrl:"views/project-details/project-details.html",controller:"ProjectDetailsCtrl"})}]).controller("ProjectDetailsCtrl",["$rootScope","$scope","$routeParams","$translate",function(e,t,r,o){$("html,body").scrollTop(0),e.showBanner=!1,t.tabAssetsVisible=!0,t.tabBorrowersVisible=!1,t.tabSponsorsVisible=!1,t.tabCommentsVisible=!1,t.titleReview="",t.ratingReview="",t.contentReview="",t.reviews=[],t.totalOffers=0,t.promOffers=0,t.offerValue=0,t.projectId=r.id,t.project={},t.sponsorsList=[],t.assetsList=[],t.borrowerList=[],t.imageList=[],t.projects=[],t.imageOpenModal=0,t.countVisit=0,t.countOffers=0,t.countShopCar=0,e.activeList="projects",t.projectTitle="",t.projectCompany="",t.projectDescription="",t.projectDebitAmount="",t.projectPrincipal="",t.projectComeFrom="",t.projectProvince="",t.projectAddress="",t.projectCredits="",t.projectManagerId="",t.projectManagerName="",t.projectManagerPhone="",t.projectHot=!1,t.projectHouse=!1,t.projectRecommended=!1,t.projectFactory=!1,t.projectDebt=!1,t.projectShop=!1,t.init=function(){var e=t.projectId,r=new AV.Query("Project");r.include("projectManager"),r.get(e).then(function(e){t.project=e,t.project.wished=!1,t.fectComments(),t.projectTitle=e.get("title"),t.projectCompany=e.get("companyName"),t.projectDescription=e.get("description"),t.projectDebitAmount=e.get("debitAmount"),t.projectPrincipal=e.get("debitPricipalInterest"),t.projectComeFrom=e.get("comefrom"),t.projectProvince=e.get("province"),t.projectAddress=e.get("plainAddress"),t.projectCredits=e.get("creditHighlights"),t.projectManagerId=e.get("projectManager").id,t.projectManagerName=e.get("projectManager").get("name"),t.projectManagerPhone=e.get("projectManager").get("phone"),t.projectHot=e.get("isHot"),t.projectHouse=e.get("isHouse"),t.projectRecommended=e.get("isRecommended"),t.projectFactory=e.get("isFactory"),t.projectDebt=e.get("isDebt"),t.projectShop=e.get("isShop");var r=new AV.Query("Sponsorship");r.equalTo("project",e),r.find().then(function(e){t.sponsorsList=e,t.$apply()});var o=new AV.Query("Asset");o.equalTo("project",e),o.find().then(function(e){t.assetsList=e,t.$apply()});var a=new AV.Query("Borrower");a.equalTo("project",e),a.find().then(function(e){for(var r=0;r<e.length;r++)e[r].set("totalInterest",parseFloat(e[r].get("principalDebit"))+parseFloat(e[r].get("interestCreditor")));t.borrowerList=e,t.$apply()});var n=new AV.Query("ProjectMedia");n.equalTo("project",e),n.find().then(function(e){console.log(e.length);for(var r=0;r<e.length;r++)e[r].set("imageUrl",e[r].get("image").thumbnailURL(200,150)),e[r].set("url",e[r].get("image").thumbnailURL(1280,720));t.imageList=e,t.$apply()});var c=new AV.Query("ProjectVisit");c.equalTo("project",e),c.count().then(function(e){t.countVisit=e,t.$apply()});var i=new AV.Query("ShopCar");i.equalTo("project",e),i.count().then(function(e){t.countShopCar=e,t.$apply()});var s=new AV.Query("Offert");s.equalTo("project",e),s.count().then(function(e){t.countOffers=e,t.$apply()});var p=new AV.Query("ShopCar");p.equalTo("project",e),p.equalTo("user",AV.User.current()),p.count().then(e=>{e>0&&(t.project.wished=!0),t.$apply()});var l=new AV.Query("Offert");l.equalTo("project",e),l.find().then(function(e){t.totalOffers=e.length;for(var r=0,o=0;o<t.totalOffers;o++)r+=parseFloat(e[o].get("amount"));t.promOffers=parseFloat(r/t.totalOffers),t.promOffers=Math.round(t.promOffers*Math.pow(10,2))/Math.pow(10,2),t.$apply()}),t.$apply()});var o=new AV.Query("Project");o.limit(5),o.equalTo("isRecommended",!0),o.find().then(function(e){t.projects=[],e.forEach(function(e){var r=e.get("image").thumbnailURL(260,160),o=e.get("title"),a=e.id,n=e.get("debitAmount");t.projects.push({id:a,mainImage:r,title:o,amount:n}),t.$apply()}),t.$apply()}).catch(function(e){alert(JSON.stringify(e))})},t.init(),t.goToProject=function(t){e.customGoTo("project-details/"+t)},t.publishReview=function(){var e=AV.User.current();if(e&&""!=t.ratingReview&&""!=t.contentReview){var r=new AV.Object("ForumComment");r.set("content",t.contentReview),r.set("user",e),r.set("rating",t.ratingReview),r.set("avatarUrl",e.get("avatarUrl"));var o=AV.Object.createWithoutData("Project",t.project.id);r.set("project",o);var a=new AV.ACL;a.setPublicReadAccess(!0),a.setPublicWriteAccess(!0),r.setACL(a),r.save().then(function(e){e.createdAt=e.createdAt.toLocaleDateString("zh-CN")+" "+e.createdAt.toLocaleTimeString("zh-CN");var r=parseInt(e.get("rating"));e.rating=[5];for(var o=0;o<r;o++)e.rating[o]={id:o,class:"text-default"};for(var a=r;a<5;a++)e.rating[a]={id:o,class:""};t.reviews.push(e),t.ratingReview="",t.contentReview="",t.$apply()}).catch(function(e){console.log(e)})}},t.fectComments=function(){if(AV.User.current()){var e=new AV.Query("ForumComment");e.equalTo("project",t.project),e.find().then(function(e){t.reviews=[];for(var r=0;r<e.length;r++){e[r].createdAt=e[r].createdAt.toLocaleDateString("zh-CN")+" "+e[r].createdAt.toLocaleTimeString("zh-CN");var o=parseInt(e[r].get("rating"));e[r].rating=[5];for(var a=0;a<o;a++)e[r].rating[a]={id:a,class:"text-default"};for(var n=o;n<5;n++)e[r].rating[n]={id:a,class:""}}console.log(e),t.reviews=e})}},t.addToWhishList=function(){var r=AV.User.current();if(r){var a=AV.Object.createWithoutData("Project",t.project.id),n=new AV.Query("ShopCar");n.equalTo("project",a),n.equalTo("user",r),n.count().then(n=>{if(n>0){var c=o.instant("ALREADYINWISHLIST");e.displayAlert("warning",c)}else{var i=new AV.Object("ShopCar");i.set("user",r),i.set("checked",!1),i.set("project",a),i.save().then(r=>{var a=o.instant("ADDEDWISHLIST");e.displayAlert("success",a),t.project.wished=!0,t.$apply()})}})}else e.customGoTo("login/projects")},t.removeToWhishList=function(){var r=AV.User.current();if(r){var a=AV.Object.createWithoutData("Project",t.project.id),n=new AV.Query("ShopCar");n.equalTo("project",a),n.equalTo("user",r),n.find().then(r=>{r.forEach(function(r){r.destroy();var a=o.instant("REMOVEDWISHLIST");e.displayAlert("success",a),t.project.wished=!1,t.$apply()})})}},t.flagBid=!1,t.bid="",t.makeAnOffer=function(){AV.User.current()?t.flagBid=!t.flagBid:e.customGoTo("login/project-details/"+t.project.id)},t.makeABid=function(){var r=AV.User.current();if(r){var a=AV.Object.createWithoutData("Project",t.project.id),n=new AV.Object("Offert");n.set("user",r),n.set("project",a),n.set("amount",t.offerValue),n.set("pending",!0);var c=new AV.ACL;c.setPublicReadAccess(!0),c.setPublicWriteAccess(!0),n.setACL(c),n.save(),t.offerValue=0,t.flagBid=!t.flagBid;var i=o.instant("OFFERMADE");e.displayAlert("success",i);var s=new AV.Query("Offert");s.equalTo("project",a),s.find().then(function(e){t.totalOffers=e.length;for(var r=0,o=0;o<t.totalOffers;o++)r+=parseFloat(e[o].get("amount"));t.promOffers=parseFloat(r/t.totalOffers),t.promOffers=Math.round(t.promOffers*Math.pow(10,2))/Math.pow(10,2),t.$apply()})}else e.customGoTo("login/project-details/"+t.project.id)}}]);